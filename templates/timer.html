{% extends "base.html" %}
{% block title %}üéÆ–¢–∞–π–º–µ—Ä ‚Äî GameBalance{% endblock %}
{% block content %}
<div class="card">
  <h2>–¢–∞–π–º–µ—Ä</h2>
  <p>50 –º–∏–Ω—É—Ç –∏–≥—Ä—ã ‚Üí 10 –º–∏–Ω—É—Ç –ø–µ—Ä–µ—Ä—ã–≤–∞</p>

  <div style="margin: 2rem 0; text-align: center;">
    <div id="display" style="font-size: 4rem; font-weight: 700; margin: 1rem 0; color: #4f46e5;">50:00</div>
    <button id="control-btn" class="btn" style="background: #4f46e5;">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
    <button id="reset-btn" class="btn btn-secondary" style="background: #666; margin-left: 10px;">‚èπ –°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>

  <p><strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ –¥–∞–∂–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å–∞–π—Ç–∞.</p>
</div>

<!-- –ó–≤—É–∫ -->
<audio id="alarm-sound" preload="auto">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
</audio>

<script>
let startTime = null;
let timeLeft = 50 * 60; // 50 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
let isRunning = false;
let targetEndTime = null;
let tickInterval = null;

function updateDisplay() {
  const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
  const secs = (timeLeft % 60).toString().padStart(2, '0');
  document.getElementById('display').textContent = `${mins}:${secs}`;
}

function updateButton() {
  const btn = document.getElementById('control-btn');
  if (isRunning) {
    btn.textContent = '‚è∏ –ü–∞—É–∑–∞';
    btn.style.background = '#666';
  } else {
    btn.textContent = '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    btn.style.background = '#4f46e5';
  }
}

function playAlarm() {
  const audio = document.getElementById('alarm-sound');
  audio.currentTime = 0;
  audio.play().catch(e => console.log("–ó–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω"));
}

function tick() {
  if (!isRunning) return;

  const now = Date.now();
  const remaining = Math.max(0, Math.floor((targetEndTime - now) / 1000));

  if (remaining !== timeLeft) {
    timeLeft = remaining;
    updateDisplay();
  }

  if (timeLeft <= 0) {
    stopTimer();
    playAlarm();
    alert('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤.');
  }
}

function startTimer() {
  if (isRunning) {
    pauseTimer();
    return;
  }

  isRunning = true;
  targetEndTime = Date.now() + timeLeft * 1000;
  updateButton();

  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 100 –º—Å ‚Äî –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
  tickInterval = setInterval(tick, 100);
}

function pauseTimer() {
  if (!isRunning) return;
  isRunning = false;
  clearInterval(tickInterval);
  updateButton();
}

function stopTimer() {
  isRunning = false;
  clearInterval(tickInterval);
  updateButton();
}

function resetTimer() {
  stopTimer();
  timeLeft = 50 * 60;
  updateDisplay();
  document.getElementById('control-btn').textContent = '‚ñ∂ –ù–∞—á–∞—Ç—å';
  document.getElementById('control-btn').style.background = '#4f46e5';
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function loadState() {
  const saved = sessionStorage.getItem('gamebalance_timer');
  if (saved) {
    const state = JSON.parse(saved);
    timeLeft = state.timeLeft;
    isRunning = state.isRunning;
    updateDisplay();
    updateButton();
    if (isRunning) {
      targetEndTime = Date.now() + timeLeft * 1000;
      tickInterval = setInterval(tick, 100);
    }
  } else {
    updateDisplay();
    updateButton();
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function saveState() {
  sessionStorage.setItem('gamebalance_timer', JSON.stringify({
    timeLeft,
    isRunning
  }));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
  loadState();

  document.getElementById('control-btn').addEventListener('click', () => {
    if (isRunning) {
      pauseTimer();
    } else {
      startTimer();
    }
    saveState();
  });

  document.getElementById('reset-btn').addEventListener('click', () => {
    resetTimer();
    sessionStorage.removeItem('gamebalance_timer');
  });

  window.addEventListener('beforeunload', saveState);
});
</script>
{% endblock %}